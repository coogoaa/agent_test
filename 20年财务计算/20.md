```java
package com.osw.marketing.web.domain.service.impl;

import cn.hutool.core.collection.CollectionUtil;
import com.osw.marketing.web.application.dto.BaseMonthDataDTO;
import com.osw.marketing.web.application.dto.PanelLocationInfo;
import com.osw.marketing.web.application.dto.ProposalDesignCalDataDTO;
import com.osw.marketing.web.domain.aggregate.*;
import com.osw.marketing.web.domain.aggregate.valueobject.*;
import com.osw.marketing.web.domain.service.DesignSchemeCommonCalDomain;
import com.osw.marketing.web.domain.service.ElectricityConsumptionConfigDomain;
import com.osw.marketing.web.domain.service.InstallerDomain;
import com.osw.marketing.web.domain.service.PanelBatteryConfigDomain;
import com.osw.marketing.web.domain.service.strategy.CountryDeductionFactory;
import com.osw.marketing.web.domain.service.strategy.DesignSchemeStrategy;
import com.osw.marketing.web.infrastructure.db.dataobject.*;
import com.osw.marketing.web.shared.enums.DesignType;
import com.osw.marketing.web.shared.enums.PlanNo;
import com.osw.marketing.web.shared.enums.ProductClassEnum;
import com.osw.marketing.web.shared.util.CalUsagePowerUtils;
import com.osw.marketing.web.shared.util.GeneratorMultiListUtils;
import com.osw.marketing.web.shared.util.IRRCalculatorUtils;
import com.osw.marketing.web.shared.util.JsonUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.time.YearMonth;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static cn.hutool.core.util.NumberUtil.max;
import static cn.hutool.core.util.NumberUtil.min;

/**
 * @author lucas.gu
 * @date 2025/10/15
 * @describe
 */
@Service
public class DesignSchemeCommonCalDomainImpl implements DesignSchemeCommonCalDomain {
    @Autowired
    private SystemConfigRepository systemConfigRepository;
    @Autowired
    private ElectricityConsumptionConfigDomain electricityConsumptionConfigDomain;
    @Autowired
    private CountryDeductionFactory countryDeductionFactory;
    @Autowired
    private SysCountryHourElectricityPercentRepository sysCountryHourElectricityPercentRepository;
    @Autowired
    private SysCountryMonthElectricityPercentRepository sysCountryMonthElectricityPercentRepository;
    @Autowired
    private InstallerDomain installerDomain;
    @Autowired
    private SysCountryHourGenElectricityPercentRepository sysCountryHourGenElectricityPercentRepository;
    @Autowired
    private SysCountryMonthGenElectricityPercentRepository sysCountryMonthGenElectricityPercentRepository;


    @Override
    public DesignVO generationPlan(DesignType designType, ProjectVO projectVO, PanelBatteryParamsVO configVO, DesignCalVO designCalVO, OswProductPanelVO panel, BigDecimal solarKw) {

        SystemConfigDO systemConfigDO = systemConfigRepository.list().get(0);
        InstallerInfoVO installerInfoVO = installerDomain.getByCode(projectVO.getInstallerCode());
        BigDecimal annualGeneratePower = BigDecimal.ZERO;
        List<List<BigDecimal>> generatePower = GeneratorMultiListUtils.initTwoMultiList(12, 24);
        for (PanelLocationInfo panelLocation : designCalVO.getPanelLocationInfos()) {
            if (!panelLocation.getGenerationPowerVO().getCalStatus()) {
                //只要有一个计算发电量失败就走兜底逻辑
                annualGeneratePower = systemConfigDO.getAnnualGenerationKwh().multiply(solarKw);
                generatePower = calMonthHourGenPowerByAnnualPower(projectVO, annualGeneratePower);
                break;
            }
            List<List<BigDecimal>> monthlyHourlyPowerList = panelLocation.getGenerationPowerVO().getMonthlyHourlyPowerList();
            for (int i = 0; i < 12; i++) {
                List<BigDecimal> hourlyPowers = monthlyHourlyPowerList.get(i);
                List<BigDecimal> resultHourlyPowers = generatePower.get(i);
                for (int j = 0; j < 24; j++) {
                    resultHourlyPowers.set(j, resultHourlyPowers.get(j).add(hourlyPowers.get(j)));
                }
            }
            annualGeneratePower = annualGeneratePower.add(panelLocation.getGenerationPowerVO().getAnnualGeneratePower().multiply(new BigDecimal(panelLocation.getPositions().size())));
        }
        ElectricityConsumptionConfigVO consumptionConfigVO = electricityConsumptionConfigDomain.getByParams(projectVO.getCountryCode(), projectVO.getState());

        ThreeCoreComponentsVO coreComponentsVO = this.calPanelBatteryInventorCost(designType, designCalVO.getInstallPanelCount(), configVO.getInverterKw(), configVO.getNominalBatteryCapacityKwh(),
                panel.getUnitPrice(), systemConfigDO.getInvertorUnitPrice(), systemConfigDO.getBatteryUnitPrice());
        BigDecimal bos = this.calBos(designType, systemConfigDO, solarKw, configVO.getInverterKw(), configVO.getNominalBatteryCapacityKwh());
        BigDecimal additionalCharges = this.additionalCharges(installerInfoVO);
        BigDecimal systemTotal = coreComponentsVO.getTotalCost().add(bos).add(additionalCharges).multiply(BigDecimal.ONE.add(systemConfigDO.getTaxRate()));
        BigDecimal panelDeductionFee = BigDecimal.ZERO;
        if (designType == DesignType.PV) {
            panelDeductionFee = this.calDeduction(systemConfigDO, installerInfoVO, projectVO, ProductClassEnum.PANEL.getCode(), solarKw, configVO.getNominalBatteryCapacityKwh(), configVO.getUsableBatteryCapacityKwh());
        }
        BigDecimal batteryDeductionFee = this.calDeduction(systemConfigDO, installerInfoVO, projectVO, ProductClassEnum.BATTERY.getCode(), solarKw, configVO.getNominalBatteryCapacityKwh(), configVO.getUsableBatteryCapacityKwh());
        //rebate
        BigDecimal rebate = panelDeductionFee.add(batteryDeductionFee);
        //final price
        BigDecimal finalPrice = systemTotal.subtract(rebate);
        //panel count
        int panelCount = designCalVO.getInstallPanelCount();
        //self consumption
        SysCountryMonthElectricityPercentDO monthPercent = sysCountryMonthElectricityPercentRepository.getByParams("AU", projectVO.getState());
        List<BigDecimal> monthUsage = CalUsagePowerUtils.calculateMonthUsage(consumptionConfigVO.getAnnualUsageKwh(), JsonUtil.copyObject(monthPercent, SysCountryMonthElectricityPercentVO.class));
        SysCountryHourElectricityPercentDO hourPercent = sysCountryHourElectricityPercentRepository.getParams("AU", projectVO.getState());
        List<List<BigDecimal>> monthDailyUsagePower = CalUsagePowerUtils.calHourlyDayUsagePower(LocalDate.now().getYear(), JsonUtil.copyObject(hourPercent, SysCountryHourElectricityPercentVO.class), monthUsage);
        BaseMonthDataDTO baseMonthDataDTO = this.calBaseData(generatePower, monthDailyUsagePower, configVO.getUsableBatteryCapacityKwh());
        BigDecimal estimateConsumption = baseMonthDataDTO.getYearSelfConsumption();
        ProposalDesignCalDataDTO calDataDTO = this.calculate20YearDataFromDayBaseData(systemConfigDO, baseMonthDataDTO.getMonthSelfConsumption(), panel.getSubsequentAnnualPowerDegradation(),
                annualGeneratePower, finalPrice, baseMonthDataDTO, coreComponentsVO.getBatteryCost(), true);
        //solarKw:system size
        BigDecimal systemSize = solarKw;
        //battery capacity
        BigDecimal usableBatteryCapacityKwh = configVO.getUsableBatteryCapacityKwh();
        //annual bill save
        BigDecimal annualBillSave = calDataDTO.getAnnualElectricityBill().subtract(calDataDTO.getBuyElectricityMoneyBefore());
        //payback period
        BigDecimal paybackPeriod = calDataDTO.getPaybackPeriod();
        //irr
        Double irr = calDataDTO.getIrr();
        DesignVO designVO = new DesignVO();
        designVO.setLayout(JsonUtil.toJsonString(designCalVO));
        designVO.setDesignType(designType.getValue());
        designVO.setProjectId(projectVO.getId());
        designVO.setSystemSize(systemSize);
        designVO.setUpfrontInvestment(finalPrice);
        designVO.setUpfrontInvestmentMin(finalPrice.multiply(BigDecimal.ONE.subtract(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setUpfrontInvestmentMax(finalPrice.multiply(BigDecimal.ONE.add(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setSubsidy(rebate);
        designVO.setAnnualBillSavingsMax(annualBillSave.multiply(BigDecimal.ONE.add(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setAnnualBillSavingsMin(annualBillSave.multiply(BigDecimal.ONE.subtract(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setAnnualBillSavings(annualBillSave);
        designVO.setIrr(new BigDecimal(irr));
        designVO.setPaybackPeriodMin(paybackPeriod.multiply(BigDecimal.ONE.subtract(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setPaybackPeriodMax(paybackPeriod.multiply(BigDecimal.ONE.add(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setPaybackPeriod(paybackPeriod);
        designVO.setSelfConsumptionMax(estimateConsumption.multiply(BigDecimal.ONE.add(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setSelfConsumptionMin(estimateConsumption.multiply(BigDecimal.ONE.subtract(systemConfigDO.getAdjustmentCoefficient())));
        designVO.setSelfConsumption(estimateConsumption);
        designVO.setBatteryCapacity(usableBatteryCapacityKwh);
        return designVO;
    }

    private ThreeCoreComponentsVO calPanelBatteryInventorCost(DesignType designType, int panelCount, BigDecimal invertorKw, BigDecimal batteryKw,
                                                              BigDecimal panelPrice, BigDecimal batteryPrice, BigDecimal invertorPrice) {
        BigDecimal panelCost = BigDecimal.ZERO;
        BigDecimal invertorCost = BigDecimal.ZERO;
        if (designType == DesignType.PV) {
            panelCost = new BigDecimal(panelCount).multiply(panelPrice);
            invertorCost = invertorKw.multiply(invertorPrice);
        }
        BigDecimal batteryCost = batteryKw.multiply(batteryPrice);
        ThreeCoreComponentsVO threeCoreComponentsVO = new ThreeCoreComponentsVO();
        threeCoreComponentsVO.setPanelCost(panelCost);
        threeCoreComponentsVO.setBatteryCost(batteryCost);
        threeCoreComponentsVO.setInvertorCost(invertorCost);
        threeCoreComponentsVO.setTotalCost(panelCost.add(batteryCost).
                add(invertorCost).
                setScale(6, RoundingMode.HALF_UP));
        return threeCoreComponentsVO;
    }

    //Balance of System
    private BigDecimal calBos(DesignType designType, SystemConfigDO systemConfigDO, BigDecimal solarKw, BigDecimal invertorKw, BigDecimal batteryKw) {
        BigDecimal panelInstallFee = BigDecimal.ZERO;
        if (designType == DesignType.PV) {
            panelInstallFee = systemConfigDO.getPanelInstallBasisFee().multiply(BigDecimal.ONE.add(systemConfigDO.getPanelInstallBasisProfit()))
                    .add(solarKw.multiply(systemConfigDO.getPanelKwInstallPrice()).multiply(BigDecimal.ONE.add(systemConfigDO.getPanelKwInstallProfit())));
        }
        BigDecimal batteryInstallFee = systemConfigDO.getBatteryInstallBasisFee().multiply(BigDecimal.ONE.add(systemConfigDO.getBatteryInstallBasisProfit()))
                .add(batteryKw.multiply(systemConfigDO.getBatteryKwInstallPrice()).multiply(BigDecimal.ONE.add(systemConfigDO.getBatteryKwInstallProfit())));
        return panelInstallFee.add(batteryInstallFee);
    }

    private BigDecimal additionalCharges(InstallerInfoVO installerInfoVO) {
        BigDecimal additionalCharges = BigDecimal.ZERO;
        if (CollectionUtil.isNotEmpty(installerInfoVO.getAdditionalCharges())) {
            for (InstallerInfoVO.AdditionalChargeItemVO additionalCharge : installerInfoVO.getAdditionalCharges()) {
                additionalCharges = additionalCharges.add(additionalCharge.getCost() == null ? BigDecimal.ZERO : additionalCharge.getCost());
            }
        }
        return additionalCharges;
    }

    private BigDecimal calDeduction(SystemConfigDO systemConfigDO,
                                    InstallerInfoVO installerInfoVO,
                                    ProjectVO projectVO,
                                    String productType,
                                    BigDecimal panelKw,
                                    BigDecimal nominalCapacity,
                                    BigDecimal usableEnergy) {
        CountryDefaultDeductionVO deductionVO = countryDeductionFactory.dealSubsidize("AU", "AU", JsonUtil.copyObject(systemConfigDO, SystemConfigVO.class),
                installerInfoVO, projectVO, productType, panelKw, nominalCapacity, usableEnergy);
        return deductionVO.getTotalPrice();
    }

    private BaseMonthDataDTO calBaseData(List<List<BigDecimal>> generatePower,
                                         List<List<BigDecimal>> usagePower,
                                         BigDecimal batteryCapacity) {
        int currentYear = LocalDate.now().getYear();
        //12*24用电量
        BigDecimal genYearPower = BigDecimal.ZERO;
        BigDecimal usaGenYearPower = BigDecimal.ZERO;
        BigDecimal batteryFinalYearPower = BigDecimal.ZERO;
        //generate  Power month
        List<BigDecimal> generatePowerList = new ArrayList<>();
        //usagePower month
        List<BigDecimal> consumptionGridList = new ArrayList<>();
        List<BigDecimal> monthSelfConsumptions = new ArrayList<>(12);
        BigDecimal annualElectricityExportedAfter = BigDecimal.ZERO;
        List<Map<String, BigDecimal>> monthBaseDataList = new ArrayList<>();
        BigDecimal yearGeneratorPower = BigDecimal.ZERO;
        for (int month = 1; month < 13; month++) {
            List<BigDecimal> monthGeneratePowerList = generatePower.get(month - 1);
            List<BigDecimal> monthUsagePowerList = usagePower.get(month - 1);
            //月
            BigDecimal usageGenMonthPower = BigDecimal.ZERO;
            //天
            BigDecimal genDayPower = BigDecimal.ZERO;
            BigDecimal useDayPower = BigDecimal.ZERO;
            BigDecimal usageGenDayPower = BigDecimal.ZERO;
            BigDecimal batteryDayPower = BigDecimal.ZERO;
            for (int hour = 1; hour < 25; hour++) {
                BigDecimal genPower = monthGeneratePowerList.get(hour - 1);
                BigDecimal usaPower = monthUsagePowerList.get(hour - 1);
                //发电量
                genDayPower = genDayPower.add(genPower);
                //用电量
                useDayPower = useDayPower.add(usaPower);
                //发电里的用电量
                BigDecimal usageGenHourPower = min(genPower, usaPower);
                usageGenDayPower = usageGenDayPower.add(usageGenHourPower);
                //发电用后剩余电量用于充电  可充电量
                BigDecimal batteryHourPower = max(genPower.subtract(usaPower), BigDecimal.ZERO);
                batteryDayPower = batteryDayPower.add(batteryHourPower);
            }
            YearMonth yearMonth = YearMonth.of(currentYear, month);
            int daysInMonth = yearMonth.lengthOfMonth();
            //年发电量
            BigDecimal monthGenPower = genDayPower.multiply(new BigDecimal(daysInMonth));
            generatePowerList.add(monthGenPower);
            genYearPower = genYearPower.add(monthGenPower);
            //月发电量里用掉的电量
            usageGenMonthPower = new BigDecimal(daysInMonth).multiply(usageGenDayPower);
            consumptionGridList.add(usageGenMonthPower);
            usaGenYearPower = usaGenYearPower.add(usageGenMonthPower);
            //非发电来源耗电量(月)
            BigDecimal useMonthPowerNoSolar = useDayPower.multiply(new BigDecimal(daysInMonth)).subtract(usageGenMonthPower);
            consumptionGridList.add(useMonthPowerNoSolar);
            //最终充电所用电量：发电量用后剩余量（用于充电）、电池容量，非发电来源的耗电量：取最小值
            BigDecimal batteryFinalMonthPower = min(new BigDecimal(daysInMonth).multiply(batteryDayPower), batteryCapacity.multiply(new BigDecimal(daysInMonth)), useMonthPowerNoSolar);
            batteryFinalYearPower = batteryFinalYearPower.add(batteryFinalMonthPower);
            Map<String, BigDecimal> baseData = new HashMap<>();
            //月度发电量
            baseData.put("mP", monthGenPower);
            //月度用电量
            baseData.put("mE", usageGenMonthPower);
            baseData.put("daysInMonth", new BigDecimal(daysInMonth));
            monthBaseDataList.add(baseData);
            BigDecimal monthSelfConsumption = usageGenMonthPower.add(batteryFinalMonthPower).divide(monthGenPower, 4, RoundingMode.HALF_UP);
            monthSelfConsumptions.add(monthSelfConsumption);
            //月卖电量
            annualElectricityExportedAfter =
                    annualElectricityExportedAfter.add(monthGenPower.multiply(new BigDecimal(1).subtract(monthSelfConsumption)));
            yearGeneratorPower = yearGeneratorPower.add(monthGenPower);
        }
        BigDecimal estimateConsumption = BigDecimal.ZERO;
        if (!BigDecimal.ZERO.equals(genYearPower)) {
            estimateConsumption = usaGenYearPower.add(batteryFinalYearPower).divide(genYearPower, 4, RoundingMode.HALF_UP);
        }
        BaseMonthDataDTO dataDTO = new BaseMonthDataDTO();
        dataDTO.setGeneratePowerList(generatePowerList);
        dataDTO.setConsumptionGridList(consumptionGridList);
        dataDTO.setMonthBaseDataList(monthBaseDataList);
        dataDTO.setYearGeneratorPower(yearGeneratorPower);
        dataDTO.setAnnualElectricityExportedAfter(annualElectricityExportedAfter);
        dataDTO.setAnnualElectricityExported(BigDecimal.ZERO);
        dataDTO.setYearSelfConsumption(estimateConsumption);
        dataDTO.setMonthSelfConsumption(monthSelfConsumptions);
        return dataDTO;
    }

    private ProposalDesignCalDataDTO calculate20YearDataFromDayBaseData(SystemConfigDO systemConfigDO,
                                                                        List<BigDecimal> selfConsumptions,
                                                                        BigDecimal subsequentAnnualPowerDegradation,
                                                                        BigDecimal yearGenPower,
                                                                        BigDecimal finalPrice,
                                                                        BaseMonthDataDTO baseMonthDataDTO,
                                                                        BigDecimal batteryTotalFee,
                                                                        boolean isHasBattery) {
        ProposalDesignCalDataDTO calDataDTO = new ProposalDesignCalDataDTO();
        List<BigDecimal> cashFlows = new ArrayList<>(21);
        BigDecimal battery10YearAvgFee = batteryTotalFee.divide(new BigDecimal(120), 10, RoundingMode.HALF_UP);
        cashFlows.add(finalPrice.negate());
        //假设回本周期无穷大无法回本，用100代替
        calDataDTO.setPaybackPeriod(BigDecimal.valueOf(100));
        //没安装solar，20年每年的电费（i，ni）；Estimated 20-Year Expenses
        List<BigDecimal> buyElectricityMoneyBeforeInstallSolar20List = new ArrayList<>(20);
        calDataDTO.setBuyElectricityMoneyBeforeList(buyElectricityMoneyBeforeInstallSolar20List);
        //安装solar，20年每年的电费k；Estimated 20-Year Expenses
        List<BigDecimal> buyElectricityMoneyAfterInstallSolar20List = new ArrayList<>(20);
        calDataDTO.setBuyElectricityMoneyList(buyElectricityMoneyAfterInstallSolar20List);
        //第N年的年总电费
        BigDecimal buyElectricityMoneyAfterInstallSolarTheNthYm = BigDecimal.ZERO;
        BigDecimal buyElectricityMoneyBeforeInstallSolarTheNthYm = BigDecimal.ZERO;
        //第20年的年总电费
        BigDecimal buyElectricityMoneyAfterInstallSolar20 = BigDecimal.ZERO;
        BigDecimal buyElectricityMoneyBeforeInstallSolar20 = BigDecimal.ZERO;
        //安装第一年馈网收入(G,nG)；Annual Feed-in Income，Annual Electricity Exported
        BigDecimal feedInYearMoney = BigDecimal.ZERO;
        //安装后第一年购电费用(C、nC）；
        BigDecimal buyElectricityMoney = BigDecimal.ZERO;
        //安装前一年购电费用(A) ；Annual Electricity Bill （灰色）
        BigDecimal buyElectricityMoneyBeforeLastYearInstallSolar = BigDecimal.ZERO;
        //A为安装前的年度电费（第一年），q为价格指数化因子，N为年份，K为N年总电费
        //安装前：N年总电费：K = A * (q^N-1) / (q-1)
        //A:安装前的年度电费-第一月(€):(年度用电量*购电平均度电价+日均固定费*365)* (1+购电税费)
        //A=(E * x + 365 * z) * (1 + et) x  为购电电价 et为购电税费
        //税已在单价里面计算，后续计算使用的都为含税价
        BigDecimal feedInAll = BigDecimal.ZERO;
        //膨胀率
        BigDecimal q = systemConfigDO.getPriceIndexation().add(new BigDecimal(1));
        //现金利率
        BigDecimal m = systemConfigDO.getEffectiveInterestRate().add(new BigDecimal(1));
        //安装后年度购买电量(kWh)
        BigDecimal firstYearInstallSolarAfterUserPower = BigDecimal.ZERO;

        //需求是按月计算，
        for (int year = 1; year <= 20; year++) {
            //下面计算年数据
            //安装光伏前,年总电费
            BigDecimal yK = BigDecimal.ZERO;
            //购电费用
            BigDecimal yC = BigDecimal.ZERO;
            //安装后年度购买电量(kWh)
            BigDecimal yD = BigDecimal.ZERO;
            BigDecimal yG = BigDecimal.ZERO;

            //安装光伏前
            for (int month = 1; month <= 12; month++) {
                Map<String, BigDecimal> monthBaseData = baseMonthDataDTO.getMonthBaseDataList().get(month - 1);
                BigDecimal daysInMonth = monthBaseData.get("daysInMonth");
                //计算没有安装光伏时的购电费用
                //1、计算固定费用
                BigDecimal monthFixedCharge = daysInMonth.multiply(systemConfigDO.getFixedChargeDayIncTax());
                //计算安装光伏前第N年的总电费
                BigDecimal mA = monthBaseData.get("mE")
                        .multiply(systemConfigDO.getElectricityPricePerKwhIncTax())
                        .add(monthFixedCharge);
                //第year年month月总购电费用
                BigDecimal ymK = mA;
                //计算折现的
                BigDecimal ymKzx = mA.multiply(q.pow(year)).divide(m.pow(year), 10,
                        RoundingMode.HALF_UP);
                yK = yK.add(ymK);

                //year年month月发电量
                BigDecimal ymP = monthBaseData.get("mP")
                        .multiply((BigDecimal.ONE
                                .subtract(subsequentAnnualPowerDegradation == null ? new BigDecimal("0.004") :
                                        subsequentAnnualPowerDegradation)).pow(year - 1));
                //月度产电自用电量
                //月度自用电量 :月自用电量=月发电量*自用率
                //月自用电量与月用电量进行比较：取月发电量*自用率 与月用电量中的最小值
                BigDecimal selfConsumption = selfConsumptions.get(month - 1);
                BigDecimal ymU;
                if (isHasBattery) {
                    ymU = min(ymP.multiply(selfConsumption), monthBaseData.get("mE"));
                } else {
                    ymU = ymP.multiply(selfConsumption);
                }
                //年月馈网电量
                BigDecimal ymS = ymP.subtract(ymU);
                //年月购电量
                BigDecimal ymD = max(monthBaseData.get("mE").subtract(ymU), BigDecimal.ZERO);
                // 安装后的购电费用（非/净计量）
                BigDecimal ymC;
                // 安装后的售电收入（非/净计量） feed in incomme
                BigDecimal ymG;
                BigDecimal ymGzx;
                BigDecimal ymCzx;
                boolean isNetMetering = false;
                if (isNetMetering) {
//                安装第n年y月馈网收入
                    ymG = max(ymS.subtract(ymD), BigDecimal.ZERO)
                            .multiply(systemConfigDO.getFeedInTariffIncTax());
                    ymC = (max(ymD.subtract(ymS), BigDecimal.ZERO).multiply(systemConfigDO.getElectricityPricePerKwhIncTax()).add(monthFixedCharge));
                    ymGzx = max(ymS.subtract(ymD), BigDecimal.ZERO)
                            .multiply(systemConfigDO.getFeedInTariffIncTax()).divide(m.pow(year), 10, RoundingMode.HALF_UP);
                    ymCzx = (max(ymD.subtract(ymS), BigDecimal.ZERO).multiply(systemConfigDO.getElectricityPricePerKwhIncTax()).add(monthFixedCharge))
                            .multiply(q.pow(year)).divide(m.pow(year), 10, RoundingMode.HALF_UP);
                } else {
                    //安装第n年馈网收入
                    ymG = ymS.multiply(systemConfigDO.getFeedInTariffIncTax());
                    //安装后第n年购电费用
                    ymC = (ymD.multiply(systemConfigDO.getElectricityPricePerKwhIncTax()).add(monthFixedCharge));
                    //安装第n年馈网收入
                    ymGzx = ymS.multiply(systemConfigDO.getFeedInTariffIncTax()).divide(m.pow(year), 10, RoundingMode.HALF_UP);
                    //安装后第n年购电费用
                    ymCzx = (ymD.multiply(systemConfigDO.getElectricityPricePerKwhIncTax()).add(monthFixedCharge))
                            .multiply(q.pow(year)).divide(m.pow(year), 10, RoundingMode.HALF_UP);

                }
                yD = yD.add(ymD);
                yC = yC.add(ymC).stripTrailingZeros();
                yG = yG.add(ymG).stripTrailingZeros();
                feedInAll = feedInAll.add(ymG);
//                feedInAllZx = feedInAllZx.add(ymGzx);
                buyElectricityMoneyAfterInstallSolarTheNthYm = buyElectricityMoneyAfterInstallSolarTheNthYm.add(ymCzx.subtract(ymGzx));
                buyElectricityMoneyBeforeInstallSolarTheNthYm = buyElectricityMoneyBeforeInstallSolarTheNthYm.add(ymKzx);
                //买电的钱+设备费用 -馈网的-vpp
                //第二块电池的成本平均加到前十年
                finalPrice = finalPrice.add(battery10YearAvgFee);
                if (buyElectricityMoneyAfterInstallSolarTheNthYm.add(finalPrice).subtract(buyElectricityMoneyBeforeInstallSolarTheNthYm).compareTo(BigDecimal.ZERO) <= 0
                        && calDataDTO.getPaybackPeriod().compareTo(BigDecimal.valueOf(100)) == 0) {
                    calDataDTO.setPaybackPeriod(new BigDecimal(year - 1).add(new BigDecimal(month).divide(new BigDecimal(12), 2, RoundingMode.HALF_UP)));
                }
            }
            buyElectricityMoneyBeforeInstallSolar20List.add(buyElectricityMoneyBeforeInstallSolarTheNthYm);
            buyElectricityMoneyAfterInstallSolar20List.add(buyElectricityMoneyAfterInstallSolarTheNthYm.add(finalPrice));
            if (year == 1) {
                //安装第一年馈网收入(G,nG)；Annual Feed-in Income，Annual Electricity Exported
                feedInYearMoney = feedInAll.stripTrailingZeros();
                //安装后第一年购电费用(C、nC）；Annual Electricity Bill （黑色）
                buyElectricityMoney = yC;
                //安装前一年购电费用(A) ；Annual Electricity
                buyElectricityMoneyBeforeLastYearInstallSolar = yK;
                //购买电量
                firstYearInstallSolarAfterUserPower = yD;
            }
            buyElectricityMoneyBeforeInstallSolar20 = buyElectricityMoneyBeforeInstallSolar20.add(yK);
            buyElectricityMoneyAfterInstallSolar20 = buyElectricityMoneyAfterInstallSolar20.add(yC.subtract(yG));
            BigDecimal cashFlow = yC.add(yG).subtract(buyElectricityMoneyBeforeLastYearInstallSolar);
            if (year == 10) {
                cashFlow = cashFlow.add(batteryTotalFee);
            }
            cashFlows.add(cashFlow);
        }


        calDataDTO.setFeedInYearMoney(feedInYearMoney);
        calDataDTO.setBuyElectricityMoneyBefore(buyElectricityMoneyBeforeLastYearInstallSolar);
        calDataDTO.setBuyElectricityMoneyBefore20(buyElectricityMoneyBeforeInstallSolar20);
        calDataDTO.setBuyElectricityMoneyAfter20(buyElectricityMoneyAfterInstallSolar20.add(finalPrice));
        calDataDTO.setAnnualBuyPowerAfterSolar(firstYearInstallSolarAfterUserPower);
        calDataDTO.setConsumptionGridList(baseMonthDataDTO.getConsumptionGridList());
        calDataDTO.setGeneratePowerList(baseMonthDataDTO.getGeneratePowerList());
        calDataDTO.setAnnualUsagePowerBeforeSolar(yearGenPower);
        calDataDTO.setAnnualElectricityExported(baseMonthDataDTO.getAnnualElectricityExportedAfter());
        calDataDTO.setAnnualElectricityExportedBefore(baseMonthDataDTO.getAnnualElectricityExported());
        calDataDTO.setAnnualSavePowerFee(buyElectricityMoneyBeforeLastYearInstallSolar.subtract(buyElectricityMoney));
        calDataDTO.setBuyElectricityMoney(buyElectricityMoney.subtract(feedInYearMoney));
        calDataDTO.setAnnualElectricityBill(buyElectricityMoney.subtract(feedInYearMoney));
        calDataDTO.setIrr(IRRCalculatorUtils.calculateIRR(cashFlows));
        return calDataDTO;
    }

    private List<List<BigDecimal>> calMonthHourGenPowerByAnnualPower(ProjectVO projectVO, BigDecimal annualGenPower) {
        List<List<BigDecimal>> lists = GeneratorMultiListUtils.initTwoMultiList(12, 24);
        SysCountryMonthGenElectricityPercentVO monthPercents = JsonUtil.copyObject(sysCountryMonthGenElectricityPercentRepository.getParams("AU", projectVO.getState()), SysCountryMonthGenElectricityPercentVO.class);
        SysCountryHourGenElectricityPercentVO hourPercents = JsonUtil.copyObject(sysCountryHourGenElectricityPercentRepository.getParams("AU", projectVO.getState()), SysCountryHourGenElectricityPercentVO.class);
        for (int i = 0; i < 12; i++) {
            List<BigDecimal> hours = lists.get(i);
            BigDecimal monthPercent = monthPercents.getMonthPercent(i + 1);
            for (int j = 0; j < 24; j++) {
                BigDecimal hourPercent = hourPercents.getHourPercent(j + 1);
                hours.set(j, annualGenPower.multiply(monthPercent).multiply(hourPercent));
            }
        }
        return lists;
    }

}


```