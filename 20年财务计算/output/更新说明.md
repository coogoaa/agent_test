# 完整PVGIS模拟器 - 更新说明

## 📅 2025-10-24 更新 (v2.0)

### ✅ 已确认包含的财务因素

#### 1. 每日固定费用 ✅
- **状态**: 已包含（从v1.0开始就有）
- **实现**: 
  ```python
  purchase_cost = grid_import × electricity_price × year_factor + days × fixed_charge_day
  cost_without_solar = month_usage × electricity_price × year_factor + days × fixed_charge_day
  ```
- **验证**: 第1年第1月购电费 = $24.80 = 31天 × $0.80/天 ✅

#### 2. 电费通货膨胀 ✅
- **状态**: 已包含（从v1.0开始就有）
- **实现**:
  ```python
  year_factor = (1 + price_indexation)^year
  # 电价会逐年增长 2.5%
  ```
- **验证**: 第1年因子=1.025, 第20年因子=1.6386 ✅

#### 3. 贴现率（新增）✅
- **状态**: **本次更新新增**
- **实现**:
  ```python
  discount_factor = 1 / (1 + discount_rate)^(year + month/12)
  discounted_saving = monthly_saving × discount_factor
  ```
- **新增字段**:
  - `discount_factor` - 贴现因子
  - `discounted_saving` - 贴现后月节省
  - `cumulative_discounted_saving` - 累计贴现后节省
  - `discounted_payback_progress` - 贴现回本进度
  - `npv` - 净现值

---

## 🆕 新增功能

### 1. 贴现计算
- 每月计算贴现因子
- 累计贴现后节省
- 贴现回本周期
- NPV（净现值）计算

### 2. 双重财务指标
现在提供两套完整的财务数据：

| 指标 | 名义值 | 贴现值 |
|------|--------|--------|
| 20年总节省 | $48,581 | $28,568 |
| 回本周期 | 8.33年 | 10.50年 |
| 回本进度 | 313.4% | 184.3% |
| NPV | - | $13,068 |

### 3. 增强的配置信息
JSON metadata现在包含：
```json
{
  "tariff": {
    "electricity_price_kwh": 0.35,
    "feed_in_tariff": 0.06,
    "fixed_charge_day": 0.8,
    "price_indexation": 0.025
  },
  "finance": {
    "upfront_investment": 18000.0,
    "subsidy": 2500.0,
    "final_price": 15500.0,
    "discount_rate": 0.05
  }
}
```

### 4. 扩展的CSV输出
从16列扩展到20列：
- 新增：贴现因子
- 新增：贴现后节省($)
- 新增：累计贴现后节省($)
- 新增：贴现回本进度(%)

---

## 📊 数据对比

### 第1年第1月示例
```
名义值:
- 月节省: $167.06
- 累计节省: $167.06
- 回本进度: 1.08%

贴现值:
- 贴现因子: 0.9524
- 贴现后节省: $159.11
- 累计贴现后节省: $159.11
- 贴现回本进度: 1.03%
```

### 第20年第12月示例
```
名义值:
- 月节省: ~$200
- 累计节省: $48,581
- 回本进度: 313.4%

贴现值:
- 贴现因子: 0.3769
- 贴现后节省: ~$75
- 累计贴现后节省: $28,568
- 贴现回本进度: 184.3%
```

---

## 🔍 验证清单

### ✅ 每日固定费用
```
验证方法: 查看购电费
第1年第1月: 购电量=0, 购电费=$24.80
计算: 31天 × $0.80/天 = $24.80 ✅
```

### ✅ 电费通胀
```
验证方法: 比较不同年份的电价
第1年: 年度因子 = 1.025
第2年: 年度因子 = 1.0506
第20年: 年度因子 = 1.6386
计算: (1.025)^20 = 1.6386 ✅
```

### ✅ 贴现率
```
验证方法: 查看贴现因子
第1年第1月: 0.9524 = 1/(1.05)^1 ✅
第10年第6月: 0.6139 = 1/(1.05)^10.5 ✅
第20年第12月: 0.3769 = 1/(1.05)^20 ✅
```

---

## 📁 生成的文件

### output/ 目录
1. **完整PVGIS模拟数据_240个月.json** (787KB)
   - 包含完整的240个月数据
   - 包含所有配置参数
   - 包含名义值和贴现值总结

2. **完整PVGIS模拟数据_240个月.csv** (29KB)
   - 20列详细数据
   - Excel可直接打开
   - 适合数据分析

---

## 🎯 使用建议

### 1. 查看总体财务表现
```bash
# 查看JSON summary部分
cat output/完整PVGIS模拟数据_240个月.json | grep -A 10 "summary"
```

### 2. Excel分析
```
1. 打开 output/完整PVGIS模拟数据_240个月.csv
2. 创建图表对比名义值 vs 贴现值
3. 分析回本进度曲线
```

### 3. 修改配置重新运行
```python
# 编辑 完整PVGIS集成模拟器.py
self.tariff = {
    'fixed_charge_day': Decimal('1.00'),      # 改为$1.00/天
    'price_indexation': Decimal('0.03'),      # 改为3%通胀
}
self.finance = {
    'discount_rate': Decimal('0.06'),         # 改为6%贴现率
}
```

然后运行：
```bash
python3 完整PVGIS集成模拟器.py --no-pvgis
mv 完整PVGIS模拟数据_240个月.* output/
```

---

## 📞 常见问题

### Q1: 为什么贴现回本期(10.5年)比名义回本期(8.33年)长？
**A**: 因为贴现考虑了货币时间价值。未来的钱在今天看来价值更低，所以需要更长时间才能回本。

### Q2: NPV是什么意思？
**A**: NPV = 净现值 = 累计贴现后节省 - 初始投资
- NPV = $13,068 > 0，说明项目值得投资
- NPV越大，项目越有利

### Q3: 如何理解贴现因子？
**A**: 贴现因子表示未来的钱折算到现在的比例
- 第1年: 0.9524 (未来1年的$1 = 现在的$0.95)
- 第10年: 0.6139 (未来10年的$1 = 现在的$0.61)
- 第20年: 0.3769 (未来20年的$1 = 现在的$0.38)

### Q4: 固定费用在哪里体现？
**A**: 在两个地方：
1. 购电费 = 购电量费用 + 固定费用
2. 无太阳能电费 = 用电量费用 + 固定费用

即使购电量为0，仍需支付固定费用。

---

## 🔄 版本历史

### v2.0 (2025-10-24)
- ✅ 新增贴现率计算
- ✅ 新增NPV指标
- ✅ 新增贴现回本期
- ✅ 扩展CSV到20列
- ✅ 增强metadata配置信息
- ✅ 确认固定费用和通胀已包含

### v1.0 (2025-10-24)
- ✅ PVGIS API集成
- ✅ 24小时能量流计算
- ✅ 电池充放电逻辑
- ✅ 能量守恒验证
- ✅ 每日固定费用
- ✅ 电费通货膨胀
- ✅ 240个月完整模拟

---

**更新时间**: 2025-10-24 22:29  
**当前版本**: v2.0  
**下次更新**: 根据需求
