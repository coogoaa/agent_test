# 屋顶光伏发电量计算方案 (v2)

## 1. 目标

根据用户提供的屋顶地理坐标、各坡面参数（倾角、方位角、面板数量）以及光伏面板信息（额定功率、衰减率），设计一个程序，调用 PVGIS API 来计算并汇总整个屋顶的预估总光伏发电量，并提供月度发电数据和小时级辐射数据。

## 2. 技术选型

*   **核心服务**: [PVGIS (Photovoltaic Geographical Information System)](https://joint-research-centre.ec.europa.eu/photovoltaic-geographical-information-system-pvgis_en)
*   **API 端点**:
    *   `PVcalc`: 用于计算并网光伏系统的年、月发电量。
    *   `seriescalc`: 用于获取指定坐标的典型年小时级太阳辐射数据。

## 3. 核心流程

1.  **读取配置**: 从 `config.json` 文件中读取所有输入参数。
2.  **获取小时辐射数据**:
    *   调用一次 `seriescalc` API，传入地理坐标，获取该地的小时级太阳辐射数据。
    *   将结果保存到单独的文件中（例如 `hourly_radiation.csv`）。
3.  **遍历坡面计算发电量**:
    *   初始化一个变量用于累加总发电量。
    *   针对配置文件中的每一个屋顶坡面，执行以下操作：
        a. **计算坡面总功率**: `坡面总功率 (kWp) = 单面板功率 (W) * 面板数量 / 1000`。
        b. **构造 `PVcalc` 请求**: 使用地理坐标、坡面总功率、倾角、方位角等参数构造 API 请求。
        c. **发送请求与解析**: 调用 `PVcalc` API，解析返回的 JSON 结果，提取年发电量 (`E_y`) 和每个月的日均发电量 (`E_d`)。
        d. **累加总量**: 将当前坡面的年发电量加到总发电量中。
        e. **记录月度数据**: 记录每个坡面的月度发电数据。
4.  **输出结果**: 在控制台或结果文件中，清晰地展示以下信息：
    *   每个坡面的年发电量和月度日均发电量。
    *   所有坡面汇总后的总年发电量。
    *   小时级辐射数据文件的存放路径。

## 4. 参数映射

| 您的需求 (`发电.md`) | PVGIS API 参数 | 单位/说明 |
| :--- | :--- | :--- |
| 地理坐标 | `lat`, `lon` | 十进制度 (Decimal Degrees) |
| 坡面方位角 | `aspect` | 度。0°=南, -90°=东, 90°=西 |
| 坡面倾角 | `angle` | 度。0°=水平, 90°=垂直 |
| 单面板功率 & 数量 | `peakpower` | **需计算**: `(panel_power * count) / 1000`，单位为 kWp |
| 年衰减率 | `pv_degradation` | 百分比 (%)。使用 "Subsequent annual power degradation" (0.4%) |
| 系统损耗 | `loss` | 百分比 (%)。综合损耗，建议默认 14%，可配置 |
| 月度日均发电量 | `outputs.monthly.fixed.E_d` | API 返回值，单位 kWh/day |
| 小时辐射强度 | `seriescalc` API | 调用 `seriescalc` 获取 |

## 5. 建议的配置文件结构 (`config.json`)

```json
{
  "location": {
    "latitude": 45.0,
    "longitude": 8.0
  },
  "system_loss": 14,
  "panel_spec": {
    "power_watts": 440,
    "degradation_rate": 0.4
  },
  "roof_surfaces": [
    {
      "name": "坡面A (朝南)",
      "panel_count": 12,
      "tilt_angle": 35,
      "azimuth": 0
    },
    {
      "name": "坡面B (朝东)",
      "panel_count": 8,
      "tilt_angle": 35,
      "azimuth": -90
    }
  ]
}
```
