

现在希望增加一些需求：

## 建设方案分为两种类型：
（1）新建系统：新建系统指得是光伏面板、逆变器、电池均需要计算与确定。
（2）储能扩容：储能扩容值得是在已有光伏面板系统上只做电池的扩容，电池的容量需要计算与确定。
（3）每种类型都包括 ABC 三套方案
## 需要根据以下规则来计算方案的系统组成，然后再计算系统投入：
2.1.1 推算光伏系统容量和面板数量
- A、B、C三个方案使用相同的光伏系统容量，上游会根据屋顶形态，把面板铺满，得到屋顶的理论最大面板数量roof_max_panels，根据方案容量系数，得到方案实际的光伏面板数量panel_count
panel_count = FLOOR(roof_max_panels * plan_capacity_factor)
向下取整
- 根据方案的面板数量，推算光伏的面板数量
solar_kw = panel_count * panel_power_kw
2.1.2 推算逆变器功率
2.1.2.1 方案 A 与方案 B：
【方案 A/B】 分别查 GS 功率映射表和 GD 功率映射表。
- GS 功率映射表如下：
1	2	电池标称容量	电池可用容量	逆变器功率
起始值	区间值	nominal_battery_capacity_kwh	usable_battery_capacity_kwh	inverter_kw
0	(0,5]	22.44	20.2	8
5	(5,7.5]	22.22	20	9.6
7.5	(7.5,12]	29.33	26.4	9.99
12	(12,20]	28.04	25.24	9.3
20	(20,100]	50.32	45.29	19.50
- GD 功率映射表如下
1	2	电池标称容量	电池可用容量	逆变器功率
起始值	区间值	nominal_battery_capacity_kwh	usable_battery_capacity_kwh	inverter_kw
0	(0,5]	15.00	13.50	5.00
5	(5,7.5]	14.82	13.34	5.00
7.5	(7.5,12]	17.33	15.60	7.22
12	(12,20]	22.22	20.00	10.00
20	(20,100]	41.93	37.74	15.00

2.1.2.2 方案 C：
【方案 C】inverter_kw = CEILING_TO_0.1(solar_kw / dc_ac_ratio)


2.1.3 推算电池容量
2.1.3.1 先估算年发电量
1. 先使用兜底数据：
- 兜底计算年发电量
annual_generation_kwh = solar_kw * yield_per_kw_per_year
2.1.3.2 电池容量预估
1. 估算日转移能量：
【C】 在不考虑用电量的情况，为了达到目标自用率，需要存储的日能量
（全年发电量/365）* （目标自用率 - 基线自用率）
daily_energy_to_shift_kwh = （annual_generation_kwh / 365） * （plan_c_target_sc_rate - baseline_self_consumption_rate）

【A/B】无需计算
2. 估算电池可用容量
【A/B】 分别查 GS 和 GD 的对应面板容量区间，取对应的电池容量的值

【C】使用日转移能量，结合 RTE，计算电池可用容量，且不超过50 的最大补贴门槛
公式：MIN(日转移能量 / RTE,50)
usable_battery_capacity = MIN(daily_energy_to_shift_kwh  / battery_rte,50)
- 对应GS 与 GD功率映射表详见上一章节
3. 计算各方案的电池标称容量
标称能量 = 可用容量 / DoD
nominal_battery_capacity = usable_battery_capacity / battery_dod

## 计算系统投入
根据输入的 panel_count 分别计算新建系统、储能扩容的系统容量、面板数量、逆变器功率、电池标称容量、电池可用容量以及最终的系统投入。

